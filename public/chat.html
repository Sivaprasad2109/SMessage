<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SMessage Chat</title><link rel="stylesheet" href="style.css" />
  <script src="https://blinkchat-i72t.onrender.com/socket.io/socket.io.js"></script>
  <script src="crypto-js/crypto-js.js"></script>
</head>
<body class="sm-page-bg">
  <main class="sm-chat-wrap">
    <header class="sm-chat-header">
      <div><div class="sm-chat-title">Private Room</div><div class="sm-chat-sub">Encrypted</div></div>
      <div style="display:flex; align-items:center; gap:12px;">
        <span id="roomIdBox" class="sm-room-id"></span>
        <span id="timerBox" class="sm-timer">00:00</span>
        <button id="quitBtn" class="sm-btn" style="background:#fff; color:#0a53c9;">Quit</button>
      </div>
    </header>
    <section class="sm-chat-card">
      <div id="typingIndicator" style="display:none; text-align:center;">Friend is typing...</div>
      <div id="messages" class="sm-messages"></div>
      <div class="sm-input-row">
        <textarea id="messageInput" class="sm-message-input" placeholder="Type..." rows="1"></textarea>
        <button id="sendBtn" class="sm-send-btn">Send</button>
      </div>
    </section>
  </main>
<script>
(() => {
    const socket = io("https://blinkchat-i72t.onrender.com", { transports: ["websocket", "polling"], reconnection: true });
    const params = new URLSearchParams(window.location.search);
    
    let roomId = params.get("room") || localStorage.getItem("last_room_id");
    let passcode = params.get("p") || localStorage.getItem("last_passcode");
    let secretKey = params.get("key") || localStorage.getItem("last_secret_key");
    let expireAt = Number(params.get("expireAt")) || Number(localStorage.getItem("last_expire_at"));

    if (!roomId || roomId === "null") { window.location.href = "index.html"; return; }

    const messagesDiv = document.getElementById("messages");
    const input = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const myName = localStorage.getItem("blinkchat_name") || "Anonymous";
    document.getElementById("roomIdBox").textContent = `Code: ${passcode}`;

    // AUTO-REJOIN ON CONNECT
    socket.on("connect", () => {
        socket.emit("joinRoom", { roomId, passcode, name: myName });
    });

    const timerInterval = setInterval(() => {
        const diff = expireAt - Date.now();
        if (diff <= 0) {
            clearInterval(timerInterval);
            window.location.href = "index.html";
        } else {
            const m = Math.floor(diff / 60000), s = Math.floor((diff % 60000) / 1000);
            document.getElementById("timerBox").textContent = `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
        }
    }, 1000);

    function sendMessage() {
        const msg = input.value.trim();
        if (!msg || !secretKey || !socket.connected) return;
        const encrypted = CryptoJS.AES.encrypt(msg, secretKey).toString();
        socket.emit("sendMessage", { message: encrypted });
        addMessage(myName + " (You)", msg, "right");
        input.value = "";
    }

    sendBtn.addEventListener("click", sendMessage);
    socket.on("newMessage", ({ message, from }) => {
        try {
            const dec = CryptoJS.AES.decrypt(message, secretKey).toString(CryptoJS.enc.Utf8);
            if (dec) addMessage(from, dec, "left");
        } catch (e) { addMessage("System", "[Decryption Error]", "center"); }
    });

    socket.on("systemMessage", msg => addMessage("System", msg, "center"));

    function addMessage(name, text, side) {
        const div = document.createElement("div");
        div.className = `sm-msg ${side}`;
        div.innerHTML = `<div style="font-size:0.7rem;">${name}</div><div>${text}</div>`;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    document.getElementById("quitBtn").addEventListener("click", () => {
        localStorage.removeItem("last_room_id");
        window.location.href = "index.html";
    });
})();
</script>
</body>
</html>
